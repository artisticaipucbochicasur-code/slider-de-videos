<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* ... TU CSS ORIGINAL, NO CAMBIA ... */
   body {
  margin: 0;
  padding: 0;
  background: #111;
  font-family: Arial, sans-serif;
  color: white;
  transition: transform 0.3s ease; /* Transici√≥n para el movimiento */
}
.swiper { width: 100vw; height: 100vh; }
.swiper-slide { display: flex; justify-content: center; align-items: center; position: relative; background: #000; }
/* ADAPTADO: ahora los videos ocupan el espacio del slide */
.swiper-slide video { max-width: 100%; max-height: 100%; object-fit: contain; }

#loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 24px; text-align: center; z-index: 10; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
#loader .spinner { display: inline-block; animation: spin 1.5s linear infinite; }

#lblContador {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(255, 0, 0, 0.8);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: bold;
  z-index: 9999;
  display: none;
  cursor: pointer;
}

#customAlertOverlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85) !important; /* M√°s oscuro y elegante */
  z-index: 10000;
  justify-content: center;
  align-items: center;
}
/* Bot√≥n de eliminar video (antes anuncio) */
.delete-announcement-btn {
  position: fixed;
  bottom: 130px; /* üî• lo subimos m√°s arriba */
  right: 10px;
  background: transparent;
  border: none;
  color: white;
  padding: 8px 10px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1.8rem; /* grande pero sin tapar */
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
}
.delete-announcement-btn.visible {
  opacity: 1;
  visibility: visible;
}

/* Asegura que el overlay de b√∫squeda quede arriba y pegado al top */
#searchOverlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: flex-start;   /* üëà arriba, no centrado */
  padding-top: 12px;         /* separadito del borde superior */
  z-index: 9999;             /* m√°s alto que cualquier otro overlay */
}

/* La tarjeta interior puede tener un ancho m√°ximo razonable */
#searchOverlay .custom-alert {
  width: 90%;
  max-width: 700px;
}
/* La lista de resultados con scroll para no ‚Äúcortar‚Äù resultados */
#searchResults.titles-list {
  max-height: 60vh;          /* üëà hace visible muchos resultados */
  overflow: auto;
}
.resultado-item {
  padding: 8px;
  border-bottom: 1px solid #ddd;
}
.resultado-item:hover {
  background: #f0f0f0;
}
.highlight {
  background: #a7d8ff;
  transition: background 1s ease;
}

/* üîπ Estilo para texto truncado con "m√°s" */
.truncated {
  cursor: pointer;
}
.more-link {
  color: white;
  font-weight: bold;
  font-style: italic;
  cursor: pointer;
}
.truncate {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  transition: max-height 0.4s ease, opacity 0.4s ease;
  max-height: 3em;
  opacity: 0.9;
}
.expandido {
  -webkit-line-clamp: unset;
  max-height: 1000px;
  opacity: 1;
}
/* üîπ Para truncar y expandir t√≠tulo/descripcion */
.truncate-text {
  cursor: pointer;
  display: inline-block;
  max-width: 100%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.expanded {
  white-space: normal;
  overflow: visible;
  text-overflow: clip;
}

.custom-alert {
  background-color: #1e1e1e !important;
  color: #fff !important;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.7);
  max-width: 80%;
  text-align: center;
  border: 1px solid #333;
  display: flex;
  flex-direction: column;
}
.custom-alert.confirm-delete {
  width: 300px;
  text-align: center;
}
.custom-alert.confirm-delete .btn-group {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 15px;
}
.custom-alert h2 {
  color: #fff !important;
  margin-top: 0;
  margin-bottom: 15px;
  font-size: 1.5rem;
}
.custom-alert p {
  margin: 0 0 20px;
  white-space: pre-wrap;
}
.custom-alert button {
  background-color: #2a2a2a !important;
  color: #fff !important;
  border: 1px solid #444;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1rem;
  transition: background-color 0.3s ease, transform 0.2s ease;
}
.custom-alert button:hover {
  background-color: #444 !important;
  transform: scale(1.05);
}
.titles-list {
  list-style: none;
  padding: 0;
  margin: 0 0 20px;
  max-height: 200px;
  overflow-y: auto;
  text-align: left;
}
.titles-list li {
  padding: 8px;
  background-color: #2a2a2a !important;
  border-bottom: 1px solid #333;
  cursor: pointer;
  color: #fff;
}
.titles-list li:hover {
  background-color: #444 !important;
}
/* üé® Notificaciones emergentes */
.info-dialog {
  background-color: #1e1e1e !important;
  color: #fff !important;
  border: 1px solid #333;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.8);
}
.info-dialog h2 {
  color: #fff !important;
}
/* Estilos para el overlay de t√≠tulo y descripci√≥n */
.content-overlay {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0, 0, 0, 0.6);
  color: #fff;
  padding: 10px 15px;
  border-radius: 5px;
  text-align: left;
  max-width: 80%;
  box-sizing: border-box;
  z-index: 999;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
.content-overlay h3 {
  margin-top: 0;
  margin-bottom: 5px;
  font-size: 1.2rem;
  font-weight: bold;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
}
.content-overlay p {
  margin-top: 0;
  font-size: 0.9rem;
  line-height: 1.2;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
}
/* Contenedor de comentarios (reducido por defecto) */
.comments-overlay-container {
  position: fixed;
  bottom: 60px;
  left: 10px;
  width: calc(80% - 20px);
  background: rgba(0, 0, 0, 0.6);
  color: #eee;
  padding: 10px;
  border-radius: 5px;
  box-sizing: border-box;
  z-index: 998;
  overflow-y: auto;
  transition: opacity 0.3s ease, visibility 0.3s ease, max-height 0.3s ease;
  max-height: 4em;
}
.comments-overlay-container.expanded {
  max-height: 25vh;
}
/* Estilos para la lista de comentarios */
.comments-overlay-container ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
/* Estilos para cada comentario individual */
.comments-overlay-container li {
  font-size: 0.8rem;
  line-height: 1.2;
  margin-bottom: 8px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  padding-bottom: 8px;
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
}
.comments-overlay-container li:last-child {
  border-bottom: none;
}
.comments-overlay-container li.deletable {
  cursor: pointer;
}
/* Contenedor del bot√≥n de borrado */
.delete-btn-container {
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 100px;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #e74c3c;
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  z-index: 0; 
}
/* Bot√≥n de borrado en s√≠ mismo */
.delete-btn {
  color: white;
  font-weight: bold;
  padding: 10px;
  cursor: pointer;
  user-select: none;
}
/* El comentario se desliza */
.comment-content {
  width: 100%;
  padding-left: 10px;
  padding-right: 10px;
  box-sizing: border-box;
  transition: transform 0.3s ease;
  position: relative;
  z-index: 1;
}
.comment-content.swiped {
  transform: translateX(100px);
}
.delete-btn-container.visible {
  transform: translateX(0);
}
/* Clase para ocultar los overlays */
.hidden-overlay {
  opacity: 0;
  visibility: hidden;
}

/* Estilos del nuevo contador de comentarios */
.comments-counter {
  position: fixed;
  bottom: 80px;
  right: 10px;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  padding: 8px 12px;
  border-radius: 5px;
  font-size: 14px;
  font-weight: bold;
  z-index: 999;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  cursor: pointer;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
.comments-counter .icon {
  font-size: 1.5rem;
  line-height: 1;
}
.comments-counter .count {
  font-size: 0.9rem;
}
/* Nuevo: Estilos para la barra de entrada de comentarios */
.comment-input-container {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #1a1a1a;
  padding: 10px 15px;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  gap: 8px;
  z-index: 1000;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
.comment-input-container input {
  flex-grow: 1;
  background: #333;
  border: 1px solid #555;
  border-radius: 25px;
  padding: 12px 20px;
  color: white;
  font-size: 1rem;
  outline: none;
}
.comment-input-container .send-comment-btn {
  background: transparent;
  color: white;
  border: none;
  padding: 12px 17px;
  border-radius: 20px;
  cursor: pointer;
  font-weight: bold;
  font-size: 1.8rem;
}
.comment-input-container .send-comment-btn:hover {
  background: transparent;
}
  </style>
</head>
<body>
  <div class="swiper"><div class="swiper-wrapper"></div></div>
  <div id="loader"><span class="spinner">‚è≥</span></div>
  <div id="lblContador"></div>
  <div id="customAlertOverlay">
      <div class="custom-alert">
          <h2 id="alertTitle"></h2>
          <div class="titles-list" id="alertMessage"></div>
      </div>
  </div>
  <!-- üîç Overlay de b√∫squeda -->
  <div id="searchOverlay" class="custom-alert-overlay" style="display:none;">
    <div class="custom-alert">
      <h2>Buscar video</h2>
      <input type="text" id="searchInput" placeholder="Escribe para buscar..." style="width:100%; padding:8px; margin:10px 0;">
      <div id="searchResults" class="titles-list"></div>
      <button onclick="cerrarBusqueda()">Cerrar</button>
    </div>
  </div>
  <div class="content-overlay" id="contentOverlay">
    <h3 id="currentTitle"></h3>
    <p id="currentDescription"></p>
  </div>
  <div class="comments-overlay-container" id="commentsOverlay">
    <ul id="commentsList"></ul>
  </div>
  <div class="comments-counter" id="commentsCounter">
      <span class="icon">üí¨</span>
      <span class="count" id="commentCountValue">0</span>
  </div>
  <div class="comment-input-container">
      <input type="text" id="commentInput" placeholder="Escribe un comentario...">
      <button class="send-comment-btn"><i class="fas fa-paper-plane"></i></button>
  </div>
  <button id="deleteAnnouncementBtn" class="delete-announcement-btn">
    <i class="fas fa-trash"></i>
  </button>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    // ==== VARIABLES PRINCIPALES ====
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec";
    let videosData = [];
    let indiceBusqueda = [];
    let swiperInstance = null;
    let contadorTotalAnterior = -1;
    let contadorAcumulado = 0;
    let nuevosTitulos = [];
    const loader = document.getElementById('loader');
    const lblContador = document.getElementById("lblContador");
    const contentOverlay = document.getElementById('contentOverlay');
    const commentsOverlay = document.getElementById('commentsOverlay');
    const commentsCounter = document.getElementById('commentsCounter');
    const commentCountValue = document.getElementById('commentCountValue');
    const commentsList = document.getElementById('commentsList');
    const currentTitle = document.getElementById('currentTitle');
    const currentDescription = document.getElementById('currentDescription');
    const commentInputContainer = document.querySelector('.comment-input-container');
    const commentInput = document.getElementById('commentInput');
    const sendCommentBtn = document.querySelector('.send-comment-btn');
    const deleteAnnouncementBtn = document.getElementById('deleteAnnouncementBtn');
    let contadorComentariosAnterior = -1;
    let lastTapTime = 0;
    let currentAuthorEmail = "deimer.herrera91@gmail.com";
    let currentAuthorName = "An√≥nimoDH";
    let startX = 0;
    let activeComment = null;
    let isSwiping = false;

    // ==== FUNCIONES Y EVENTOS ====
    function reconstruirIndiceBusqueda() {
      indiceBusqueda = videosData.map((v, i) => {
        const titulo = v?.titulo || "";
        const descripcion = v?.descripcion || "";
        const key = normalizar(`${titulo} ${descripcion}`);
        return { i, key, titulo: titulo || "(Sin t√≠tulo)" };
      });
    }
    function normalizar(txt) {
      return txt.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, " ").trim();
    }
    function abrirBusqueda() {
      document.getElementById("searchOverlay").style.display = "flex";
      document.getElementById("searchInput").value = "";
      document.getElementById("searchResults").innerHTML = "";
      document.getElementById("searchInput").focus();
    }
    function cerrarBusqueda() {
      document.getElementById("searchOverlay").style.display = "none";
    }
    document.getElementById("searchInput").addEventListener("input", function () {
      const query = normalizar(this.value);
      const resultadosDiv = document.getElementById("searchResults");
      resultadosDiv.innerHTML = "";
      if (query.length < 2) return;
      if (!Array.isArray(indiceBusqueda) || indiceBusqueda.length === 0) {
        resultadosDiv.innerHTML = "<p>Todav√≠a no se han cargado videos</p>";
        return;
      }
      const coincidencias = indiceBusqueda.filter(item => item.key.includes(query));
      coincidencias.forEach(item => {
        const li = document.createElement("div");
        li.textContent = item.titulo;
        li.classList.add("resultado-item");
        li.onclick = () => {
          cerrarBusqueda();
          if (swiperInstance) {
            swiperInstance.slideToLoop(item.i, 500);
            setTimeout(() => {
              currentTitle.classList.add("highlight");
              setTimeout(() => currentTitle.classList.remove("highlight"), 2000);
            }, 400);
          }
        };
        resultadosDiv.appendChild(li);
      });
      if (!resultadosDiv.hasChildNodes()) {
        resultadosDiv.innerHTML = "<p>No se encontraron coincidencias</p>";
      }
    });
    document.querySelector('.swiper').addEventListener('click', () => {
      const currentTime = new Date().getTime();
      if (currentTime - lastTapTime > 300) {
        contentOverlay.classList.toggle('hidden-overlay');
        commentsOverlay.classList.toggle('hidden-overlay');
        commentsCounter.classList.toggle('hidden-overlay');
        commentInputContainer.classList.toggle('hidden-overlay');
      }
      lastTapTime = currentTime;
    });
    commentsOverlay.addEventListener('click', (e) => {
      if (!isSwiping) commentsOverlay.classList.toggle('expanded');
      isSwiping = false;
    });
    commentsList.addEventListener('touchstart', (e) => {
      const commentElement = e.target.closest('li');
      if (!commentElement) return;
      const autorCorreo = commentElement.dataset.correo;
      if (normalizar(autorCorreo) === normalizar(currentAuthorEmail)) {
        startX = e.touches[0].clientX;
        activeComment = commentElement;
        activeComment.querySelector('.comment-content').style.transition = 'none';
        isSwiping = false;
      }
    });
    commentsList.addEventListener('touchmove', (e) => {
      if (!activeComment) return;
      const currentX = e.touches[0].clientX;
      const diffX = currentX - startX;
      if (Math.abs(diffX) > 10) isSwiping = true;
      if (diffX > 0) {
        activeComment.querySelector('.comment-content').style.transform = `translateX(${diffX}px)`;
        let deleteBtnContainer = activeComment.querySelector('.delete-btn-container');
        if (deleteBtnContainer) deleteBtnContainer.style.transform = `translateX(0)`;
      } else {
        activeComment.querySelector('.comment-content').style.transform = `translateX(0)`;
        let deleteBtnContainer = activeComment.querySelector('.delete-btn-container');
        if (deleteBtnContainer) deleteBtnContainer.style.transform = `translateX(-100%)`;
      }
    });
    commentsList.addEventListener('touchend', (e) => {
      if (!activeComment) return;
      const swipeThreshold = 50;
      const diffX = e.changedTouches[0].clientX - startX;
      const commentContent = activeComment.querySelector('.comment-content');
      let deleteBtnContainer = activeComment.querySelector('.delete-btn-container');
      commentContent.style.transition = 'transform 0.3s ease';
      if (diffX > swipeThreshold) {
        commentContent.style.transform = `translateX(100px)`;
        if (!deleteBtnContainer) {
          deleteBtnContainer = document.createElement('div');
          deleteBtnContainer.className = 'delete-btn-container';
          let deleteBtn = document.createElement('div');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = 'Borrar';
          deleteBtnContainer.appendChild(deleteBtn);
          activeComment.insertBefore(deleteBtnContainer, commentContent);
          deleteBtnContainer.style.transform = `translateX(0)`;
          deleteBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            const commentData = activeComment.dataset;
            showConfirmationDialog("¬øEst√°s seguro de que quieres borrar este comentario?", () => {
              const activeIndex = swiperInstance.realIndex;
              const currentVideo = videosData[activeIndex];
              if (currentVideo) eliminarComentario(currentVideo.id, commentData.texto, commentData.correo);
            });
          });
        } else {
          deleteBtnContainer.style.transform = `translateX(0)`;
        }
      } else {
        commentContent.style.transform = `translateX(0)`;
        if (deleteBtnContainer) deleteBtnContainer.style.transform = `translateX(-100%)`;
      }
      activeComment = null;
      startX = 0;
    });
    function updateInfo(title, description) {
      currentTitle.setAttribute("data-full", title);
      currentDescription.setAttribute("data-full", description);
      const shortTitle = title.length > 50 ? title.substring(0, 50) + ` <span class="more-link">...m√°s</span>` : title;
      const shortDescription = description.length > 80 ? description.substring(0, 80) + ` <span class="more-link">...m√°s</span>` : description;
      currentTitle.setAttribute("data-short", shortTitle);
      currentDescription.setAttribute("data-short", shortDescription);
      currentTitle.innerHTML = shortTitle;
      currentDescription.innerHTML = shortDescription;
      currentTitle.classList.remove("expanded");
      currentDescription.classList.remove("expanded");
    }
    currentTitle.addEventListener("click", function () {
      if (this.classList.contains("expanded")) {
        this.innerHTML = this.getAttribute("data-short");
        this.classList.remove("expanded");
      } else {
        this.innerHTML = this.getAttribute("data-full") + ` <span class="more-link">Mostrar menos</span>`;
        this.classList.add("expanded");
      }
    });
    currentDescription.addEventListener("click", function () {
      if (this.classList.contains("expanded")) {
        this.innerHTML = this.getAttribute("data-short");
        this.classList.remove("expanded");
      } else {
        this.innerHTML = this.getAttribute("data-full") + ` <span class="more-link">Mostrar menos</span>`;
        this.classList.add("expanded");
      }
    });
    // ... CONTIN√öA EN LA SIGUIENTE RESPUESTA ...
       // Normalizador comentarios (igual)
  function normalizarComentarios(lista) {
    if (!Array.isArray(lista)) return [];
    return [...lista]
      .reverse()
      .map(c => {
        try { if (typeof c === "string") c = JSON.parse(c); } catch(e) {}
        const autor = c?.autor ?? "";
        const fecha = c?.fecha ?? "";
        const comentario = c?.comentario ?? "";
        const correo = c?.correo ?? "";
        if (autor || fecha || comentario) {
          return { texto: `${autor} (${fecha}) - ${comentario}`, autorCorreo: correo, textoPuro: comentario };
        }
        return null;
      })
      .filter(Boolean);
  }

  // Expand/collapse overlays, truncado
  function aplicarTruncado(element, maxLength = 80) {
    const fullText = element.textContent.trim();
    if (fullText.length > maxLength) {
      const shortText = fullText.substring(0, maxLength);
      element.innerHTML = `${shortText} <span class="more-link">... m√°s</span>`;
      element.dataset.fullText = fullText;
      element.dataset.shortText = shortText;
      element.dataset.expanded = "false";
      element.onclick = (e) => {
        e.stopPropagation();
        const expanded = element.dataset.expanded === "true";
        if (expanded) {
          element.innerHTML = `${element.dataset.shortText} <span class="more-link">... m√°s</span>`;
          element.dataset.expanded = "false";
        } else {
          element.innerHTML = `${element.dataset.fullText} <span class="more-link">menos</span>`;
          element.dataset.expanded = "true";
        }
      };
    }
  }

  // ----- FUNCIONES DE CARGA, VISOR Y COMENTARIO -----
  async function cargarVideos() {
    loader.style.display = 'block';
    const currentIndex = swiperInstance ? swiperInstance.realIndex : 0;
    const currentId = swiperInstance && videosData.length > 0 ? videosData[swiperInstance.realIndex].id : null;
    try {
      const response = await fetch(`${SCRIPT_URL}?accion=listar&tipo=videos`);
      if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const result = await response.json();
      let newVideosData = [];
      if(result.status === "success" && result.data && result.data.length > 0) {
        result.data.forEach((row) => {
          newVideosData.push({
            titulo: row[0] || "",
            link: row[1] || "",
            autor: row[2] || "",
            correo: row[3] || "",
            descripcion: row[4] || "",
            id: row[5] || "",
          });
        });
      }
      newVideosData.reverse();
      const oldIds = videosData.map(v => v.id);
      const newIds = newVideosData.map(v => v.id);
      if (JSON.stringify(oldIds) === JSON.stringify(newIds)) {
        loader.style.display = 'none';
        return;
      }
      videosData = newVideosData;
      reconstruirIndiceBusqueda();
      if (swiperInstance) {
        swiperInstance.removeAllSlides();
        videosData.forEach(video => {
          const slide = document.createElement('div');
          slide.classList.add('swiper-slide');
          slide.dataset.id = video.id;
          const zoomContainer = document.createElement('div');
          zoomContainer.classList.add('swiper-zoom-container');
          const vid = document.createElement('video');
          vid.src = video.link;
          vid.controls = true;
          vid.style.maxWidth = "100%";
          vid.style.maxHeight = "100%";
          zoomContainer.appendChild(vid);
          slide.appendChild(zoomContainer);
          swiperInstance.appendSlide(slide);
        });
        let newIndex = videosData.findIndex(v => v.id === currentId);
        if (newIndex !== -1) {
          swiperInstance.slideToLoop(newIndex, 0, false);
        } else {
          if (currentIndex < videosData.length) {
            swiperInstance.slideToLoop(currentIndex, 0, false);
          } else {
            swiperInstance.slideToLoop(videosData.length - 1, 0, false);
          }
        }
        swiperInstance.update();
      } else {
        const swiperWrapper = document.querySelector('.swiper-wrapper');
        swiperWrapper.innerHTML = '';
        videosData.forEach(video => {
          const slide = document.createElement('div');
          slide.classList.add('swiper-slide');
          slide.dataset.id = video.id;
          const zoomContainer = document.createElement('div');
          zoomContainer.classList.add('swiper-zoom-container');
          const vid = document.createElement('video');
          vid.src = video.link;
          vid.controls = true;
          vid.style.maxWidth = "100%";
          vid.style.maxHeight = "100%";
          zoomContainer.appendChild(vid);
          slide.appendChild(zoomContainer);
          swiperWrapper.appendChild(slide);
        });
        initSwiper(0);
      }
      const activeIndex = swiperInstance ? swiperInstance.realIndex : 0;
      updateContentOverlay(activeIndex);
    } catch(error) {
      console.error("Error al cargar los videos:", error);
    } finally {
      loader.style.display = 'none';
    }
  }

  // Eliminar video
  async function eliminarVideo(videoId) {
    loader.style.display = 'block';
    try {
      const formData = new FormData();
      formData.append('accion', 'eliminar');
      formData.append('tipo', 'video');
      formData.append('id', videoId);
      formData.append('correo', currentAuthorEmail);
      const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
      const result = await response.json();
      if (result.status && result.status.toLowerCase().includes("success")) {
        showInfoDialog("√âxito", "Video eliminado correctamente.");
        await cargarVideos();
      } else {
        showInfoDialog("Error", result.message || "No se pudo eliminar el video.");
      }
    } catch (error) {
      showInfoDialog("Error", "Ocurri√≥ un problema al eliminar el video.");
    } finally {
      loader.style.display = 'none';
    }
  }

  // Overlay info y comentarios
  function updateContentOverlay(index) {
    if (videosData.length > index) {
      const video = videosData[index];
      updateInfo(video.titulo, video.descripcion);
      if (normalizar(video.correo) === normalizar(currentAuthorEmail)) {
        deleteAnnouncementBtn.classList.add("visible");
        deleteAnnouncementBtn.onclick = () => {
          showConfirmationDialog(
            "¬øEst√°s seguro de que quieres eliminar este video?",
            () => eliminarVideo(video.id)
          );
        };
      } else {
        deleteAnnouncementBtn.classList.remove("visible");
      }
      commentsList.innerHTML = '';
      commentsOverlay.classList.remove('expanded');
      if (video.comentarios && video.comentarios.length > 0) {
        video.comentarios.forEach(comentario => {
          const li = document.createElement('li');
          li.classList.add('deletable');
          const commentContent = document.createElement('div');
          commentContent.classList.add('comment-content');
          commentContent.textContent = comentario.texto;
          const deleteBtnContainer = document.createElement('div');
          deleteBtnContainer.className = 'delete-btn-container';
          const deleteBtn = document.createElement('div');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = 'Borrar';
          deleteBtnContainer.appendChild(deleteBtn);
          li.appendChild(deleteBtnContainer);
          li.appendChild(commentContent);
          li.dataset.id = comentario.id;
          li.dataset.correo = comentario.autorCorreo;
          li.dataset.texto = comentario.textoPuro;
          deleteBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            const activeIndex = swiperInstance.realIndex;
            const currentVideo = videosData[activeIndex];
            if(currentVideo) {
              eliminarComentario(currentVideo.id, comentario.textoPuro, comentario.autorCorreo);
            }
          });
          commentsList.appendChild(li);
        });
        commentCountValue.textContent = video.comentarios.length;
      } else {
        const li = document.createElement('li');
        li.textContent = "No hay comentarios a√∫n.";
        commentsList.appendChild(li);
        commentCountValue.textContent = 0;
      }
    }
  }

  // Swiper init
  function initSwiper(initialIndex = 0) {
    if(!swiperInstance) {
      swiperInstance = new Swiper('.swiper', {
        loop: true,
        direction: 'vertical',
        slidesPerView: 1,
        spaceBetween: 10,
        zoom: { maxRatio: 3, minRatio: 1 }
      });
      swiperInstance.on('slideChange', () => {
        const activeIndex = swiperInstance.realIndex;
        updateContentOverlay(activeIndex);
        if(window.AppInventor && videosData.length > 0) {
          const videoActual = videosData[activeIndex];
          if (!videoActual) return;
          const payload = { ...videoActual, titulos: videosData.map(v => v.titulo), contador: contadorAcumulado };
          window.AppInventor.setWebViewString(JSON.stringify(payload));
        }
      });
    }
    if(videosData.length > 0) {
      const initialSlideIndex = Math.min(initialIndex, videosData.length - 1);
      swiperInstance.slideToLoop(initialSlideIndex, 0, false);
      updateContentOverlay(initialSlideIndex);
      if(window.AppInventor){
        const videoInicial = videosData[initialSlideIndex];
        const payload = { ...videoInicial, titulos: videosData.map(v => v.titulo), contador: contadorAcumulado };
        window.AppInventor.setWebViewString(JSON.stringify(payload));
      }
    }
  }

  // Enviar comentario (adaptado)
  async function enviarComentario() {
    const comentarioTexto = commentInput.value.trim();
    const activeIndex = swiperInstance.realIndex;
    const currentVideo = videosData[activeIndex];
    if (!comentarioTexto || !currentVideo) {
      showInfoDialog("Error", "No puedes enviar un comentario vac√≠o.");
      return;
    }
    loader.style.display = 'block';
    try {
      const formData = new FormData();
      formData.append('accion', 'agregarComentarioVideo');
      formData.append('videoId', currentVideo.id);
      formData.append('comentario', comentarioTexto);
      formData.append('autor', currentAuthorName);
      formData.append('correo', currentAuthorEmail);
      const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
      const result = await response.json();
      if (result.status === "success") {
        commentInput.value = '';
        await verificarComentarios();
      } else {
        showInfoDialog("Error", `No se pudo agregar el comentario. ${result.message}`);
      }
    } catch (error) {
      showInfoDialog("Error", "Ocurri√≥ un error al intentar agregar el comentario.");
    } finally {
      loader.style.display = 'none';
    }
  }
  sendCommentBtn.addEventListener('click', enviarComentario);
  commentInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') enviarComentario();
  });
  commentInput.addEventListener('focus', () => {
    document.body.style.transform = `translateY(-50%)`;
  });
  commentInput.addEventListener('blur', () => {
    document.body.style.transform = 'translateY(0)';
  });

  // Eliminar comentario
  async function eliminarComentario(videoId, comentarioTexto, autorCorreo) {
    loader.style.display = 'block';
    try {
      const formData = new FormData();
      formData.append('accion', 'eliminarComentario');
      formData.append('videoId', videoId);
      formData.append('comentario', comentarioTexto);
      formData.append('correo', autorCorreo);
      const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
      const result = await response.json();
      if (result.status === "success") {
        await verificarComentarios();
      } else {
        showInfoDialog("Error", `No se pudo eliminar el comentario. ${result.message}`);
      }
    } catch (error) {
      showInfoDialog("Error", "Ocurri√≥ un error al intentar eliminar el comentario.");
    } finally {
      loader.style.display = 'none';
    }
  }

  // Verificar comentarios
  async function verificarComentarios() {
    try {
      const activeIndex = swiperInstance ? swiperInstance.realIndex : 0;
      const currentVideo = videosData[activeIndex];
      if (!currentVideo) return;
      const response = await fetch(`${SCRIPT_URL}?accion=listarComentarios&videoId=${encodeURIComponent(currentVideo.id)}`);
      const data = await response.json();
      currentVideo.comentarios = Array.isArray(data.data)
        ? data.data.map(c => ({
            texto: `${c[2]} (${c[4]}) - ${c[1]}`,
            autorCorreo: c[3],
            textoPuro: c[1]
          }))
        : [];
      updateContentOverlay(activeIndex);
    } catch (e) {
      console.error("Error al verificar comentarios:", e);
    }
  }

  // Notificaciones de nuevos videos
  lblContador.addEventListener("click", () => {
    if (nuevosTitulos.length === 0) {
      showCustomAlert("Nuevos videos", []);
    } else {
      showCustomAlert("Nuevos videos", nuevosTitulos);
    }
  });

  // Actualizar contador de nuevos videos
  async function actualizarContador() {
    try {
      const response = await fetch(`${SCRIPT_URL}?accion=obtenerContador&tipo=videos`);
      const data = await response.json();
      const totalActual = data.contador || 0;
      if (contadorTotalAnterior === -1) {
        contadorTotalAnterior = totalActual;
      } else {
        if (totalActual !== contadorTotalAnterior) {
          const diferencia = totalActual - contadorTotalAnterior;
          if (diferencia > 0) {
            const responseVideos = await fetch(`${SCRIPT_URL}?accion=listar&tipo=videos`);
            const dataVideos = await responseVideos.json();
            const titulosNuevos = dataVideos.data.slice(-diferencia).map(row => row[0]).reverse();
            nuevosTitulos = [...titulosNuevos, ...nuevosTitulos];
            nuevosTitulos = [...new Set(nuevosTitulos)];
            contadorAcumulado = nuevosTitulos.length;
          } else if (diferencia < 0) {
            contadorAcumulado = 0;
            nuevosTitulos = [];
          }
          if (lblContador) {
            if (contadorAcumulado > 0) {
              lblContador.textContent = `üîî ${contadorAcumulado}`;
              lblContador.style.display = "block";
            } else {
              lblContador.textContent = "";
              lblContador.style.display = "none";
            }
          }
          contadorTotalAnterior = totalActual;
          await cargarVideos();
        }
      }
    } catch (e) {
      console.error("‚ùå Error al obtener contador:", e);
    }
  }
  setInterval(actualizarContador, 5000);
  setInterval(verificarComentarios, 5000);

  // Custom alert, info, confirm
  function showCustomAlert(title, titlesList) {
    const overlay = document.getElementById('customAlertOverlay');
    const alertDiv = overlay.querySelector('.custom-alert');
    const alertTitle = document.getElementById('alertTitle');
    const alertMessage = document.getElementById('alertMessage');
    alertDiv.className = 'custom-alert';
    alertMessage.innerHTML = '';
    alertTitle.textContent = title;
    if (titlesList.length > 0) {
      const list = document.createElement('ul');
      list.className = 'titles-list';
      titlesList.forEach((titulo, index) => {
        const li = document.createElement('li');
        li.textContent = titulo;
        li.dataset.index = index;
        li.addEventListener('click', () => {
          const selectedIndex = videosData.findIndex(v => v.titulo === titulo);
          if (selectedIndex !== -1) {
            swiperInstance.slideToLoop(selectedIndex, 500);
            nuevosTitulos.splice(nuevosTitulos.indexOf(titulo), 1);
            contadorAcumulado = nuevosTitulos.length;
            if (contadorAcumulado > 0) {
              lblContador.textContent = `üîî ${contadorAcumulado}`;
            } else {
              lblContador.style.display = 'none';
            }
            document.getElementById('customAlertOverlay').style.display = 'none';
          }
        });
        list.appendChild(li);
      });
      alertMessage.appendChild(list);
    } else {
      const p = document.createElement('p');
      p.textContent = "No hay videos nuevos.";
      alertMessage.appendChild(p);
    }
    const closeBtn = document.createElement('button');
    closeBtn.textContent = "Cerrar";
    closeBtn.id = "closeAlertButton";
    closeBtn.onclick = () => overlay.style.display = 'none';
    alertMessage.appendChild(closeBtn);
    overlay.style.display = 'flex';
  }
  function showConfirmationDialog(message, onConfirm) {
    const overlay = document.getElementById('customAlertOverlay');
    const alertDiv = overlay.querySelector('.custom-alert');
    const alertTitle = document.getElementById('alertTitle');
    const alertMessage = document.getElementById('alertMessage');
    alertDiv.className = 'custom-alert confirm-delete';
    alertTitle.textContent = "Confirmar eliminaci√≥n";
    alertMessage.innerHTML = `<p>${message}</p>`;
    const buttonGroup = document.createElement('div');
    buttonGroup.className = 'btn-group';
    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'S√≠, borrar';
    confirmBtn.style.backgroundColor = '#e74c3c';
    confirmBtn.onclick = () => {
      onConfirm();
      overlay.style.display = 'none';
    };
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancelar';
    cancelBtn.onclick = () => { overlay.style.display = 'none'; };
    buttonGroup.appendChild(confirmBtn);
    buttonGroup.appendChild(cancelBtn);
    alertMessage.appendChild(buttonGroup);
    overlay.style.display = 'flex';
  }
  function showInfoDialog(title, message) {
    const overlay = document.getElementById('customAlertOverlay');
    const alertDiv = overlay.querySelector('.custom-alert');
    const alertTitle = document.getElementById('alertTitle');
    const alertMessage = document.getElementById('alertMessage');
    alertDiv.className = 'custom-alert';
    alertTitle.textContent = title;
    alertMessage.innerHTML = `<p>${message}</p>`;
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'Aceptar';
    closeBtn.onclick = () => overlay.style.display = 'none';
    alertMessage.appendChild(closeBtn);
    overlay.style.display = 'flex';
  }

  // Inicio visor
  document.addEventListener("DOMContentLoaded", () => {
    verificarComentarios().then(() => {
      cargarVideos();
    });
  });
  </script>
</body>
</html>
