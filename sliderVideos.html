<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Slider de Videos</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
<style>
  body { margin:0; font-family: Arial, sans-serif; }
  .swiper { width: 100%; height: 70vh; background: #000; }
  .swiper-slide { display: flex; justify-content:center; align-items:center; }
  .swiper-slide video { max-width: 100%; max-height: 100%; }
  .content-overlay { padding: 10px; background:#f4f4f4; }
  .comments-overlay-container { max-height: 200px; overflow-y:auto; border-top:1px solid #ccc; }
  .comment-input-container { display:flex; margin-top:5px; }
  .comment-input-container input { flex:1; padding:5px; }
  .comment-input-container button { padding:5px; }
  .delete-announcement-btn { position: fixed; top:10px; right:10px; display:none; background:red; color:#fff; border:none; padding:5px 10px; cursor:pointer; }
  .delete-announcement-btn.visible { display:block; }
  .custom-alert-overlay, #customAlertOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:1000; }
  .custom-alert { background:#fff; padding:20px; border-radius:8px; max-width:90%; max-height:80%; overflow-y:auto; }
  .titles-list { list-style:none; padding:0; margin:0; }
  .titles-list li { padding:5px; cursor:pointer; border-bottom:1px solid #ddd; }
  .hidden-overlay { display:none !important; }
  .highlight { background:yellow; }
</style>
</head>
<body>

<div class="swiper"><div class="swiper-wrapper"></div></div> 
<div id="loader"><span class="spinner">‚è≥</span></div>
<div id="lblContador"></div>

<div id="customAlertOverlay">
    <div class="custom-alert">
        <h2 id="alertTitle"></h2>
        <div class="titles-list" id="alertMessage"></div>
    </div>
</div>

<!-- üîç Overlay de b√∫squeda -->
<div id="searchOverlay" class="custom-alert-overlay" style="display:none;">
  <div class="custom-alert">
    <h2>Buscar video</h2>
    <input type="text" id="searchInput" placeholder="Escribe para buscar..." style="width:100%; padding:8px; margin:10px 0;">
    <div id="searchResults" class="titles-list"></div>
    <button onclick="cerrarBusqueda()">Cerrar</button>
  </div>
</div>

<div class="content-overlay" id="contentOverlay">
  <h3 id="currentTitle"></h3>
  <p id="currentDescription"></p>
</div>

<div class="comments-overlay-container" id="commentsOverlay">
  <ul id="commentsList"></ul>
</div>

<div class="comments-counter" id="commentsCounter">
  <span class="icon">üí¨</span>
  <span class="count" id="commentCountValue">0</span>
</div>

<div class="comment-input-container">
  <input type="text" id="commentInput" placeholder="Escribe un comentario...">
  <button class="send-comment-btn"><i class="fas fa-paper-plane"></i></button>
</div>

<!-- Bot√≥n fijo para eliminar video -->
<button id="deleteAnnouncementBtn" class="delete-announcement-btn">
  <i class="fas fa-trash"></i>
</button>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/TU_SCRIPT_ID/exec";

let videosData = [];
let indiceBusqueda = [];
let swiperInstance = null;

const loader = document.getElementById('loader');
const lblContador = document.getElementById("lblContador");
const contentOverlay = document.getElementById('contentOverlay');
const commentsOverlay = document.getElementById('commentsOverlay');
const commentsCounter = document.getElementById('commentsCounter');
const commentCountValue = document.getElementById('commentCountValue');
const commentsList = document.getElementById('commentsList');
const currentTitle = document.getElementById('currentTitle');
const currentDescription = document.getElementById('currentDescription');
const commentInputContainer = document.querySelector('.comment-input-container');
const commentInput = document.getElementById('commentInput');
const sendCommentBtn = document.querySelector('.send-comment-btn');
const deleteAnnouncementBtn = document.getElementById('deleteAnnouncementBtn');

let currentAuthorEmail = "deimer.herrera91@gmail.com";
let currentAuthorName = "An√≥nimoDH";

// üîπ Normalizar texto
function normalizar(txt) {
  return (txt || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
}

// üîπ Abrir/cerrar buscador
function abrirBusqueda() { document.getElementById("searchOverlay").style.display = "flex"; document.getElementById("searchInput").focus(); }
function cerrarBusqueda() { document.getElementById("searchOverlay").style.display = "none"; }

document.getElementById("searchInput").addEventListener("input", function () {
  const query = normalizar(this.value);
  const resultadosDiv = document.getElementById("searchResults");
  resultadosDiv.innerHTML = "";
  if (query.length < 2) return;
  const coincidencias = indiceBusqueda.filter(item => item.key.includes(query));
  coincidencias.forEach(item => {
    const div = document.createElement("div");
    div.textContent = item.titulo;
    div.classList.add("resultado-item");
    div.onclick = () => { cerrarBusqueda(); if(swiperInstance) swiperInstance.slideToLoop(item.i, 500); };
    resultadosDiv.appendChild(div);
  });
  if (!resultadosDiv.hasChildNodes()) resultadosDiv.innerHTML = "<p>No se encontraron coincidencias</p>";
});

// üîπ Funci√≥n para actualizar overlay de t√≠tulo y descripci√≥n
function updateInfo(title, description) {
  currentTitle.setAttribute("data-full", title);
  currentDescription.setAttribute("data-full", description);
  const shortTitle = title.length>50 ? title.substring(0,50)+" <span class='more-link'>...m√°s</span>" : title;
  const shortDescription = description.length>80 ? description.substring(0,80)+" <span class='more-link'>...m√°s</span>" : description;
  currentTitle.setAttribute("data-short", shortTitle);
  currentDescription.setAttribute("data-short", shortDescription);
  currentTitle.innerHTML = shortTitle;
  currentDescription.innerHTML = shortDescription;
  currentTitle.classList.remove("expanded");
  currentDescription.classList.remove("expanded");
}

// Click para expandir t√≠tulo/descripci√≥n
[currentTitle, currentDescription].forEach(el=>{
  el.addEventListener('click', function(){
    if(this.classList.contains("expanded")){
      this.innerHTML = this.getAttribute("data-short");
      this.classList.remove("expanded");
    } else {
      this.innerHTML = this.getAttribute("data-full") + " <span class='more-link'>Mostrar menos</span>";
      this.classList.add("expanded");
    }
  });
});

// Enviar comentario
async function enviarComentario() {
  const comentarioTexto = commentInput.value.trim();
  const activeIndex = swiperInstance.realIndex;
  const videoActual = videosData[activeIndex];
  if(!comentarioTexto || !videoActual) return;
  loader.style.display = 'block';
  try {
    const formData = new FormData();
    formData.append('accion', 'agregarComentarioVideo');
    formData.append('videoId', videoActual.id);
    formData.append('comentario', comentarioTexto);
    formData.append('autor', currentAuthorName);
    formData.append('correo', currentAuthorEmail);
    const response = await fetch(SCRIPT_URL, { method:'POST', body:formData });
    const result = await response.json();
    commentInput.value = '';
    cargarComentarios(videoActual.id);
  } catch(e){ console.error(e); }
  finally{ loader.style.display = 'none'; }
}
sendCommentBtn.addEventListener('click', enviarComentario);
commentInput.addEventListener('keydown', e=>{ if(e.key==='Enter') enviarComentario(); });

// Cargar videos
async function cargarVideos() {
  loader.style.display = 'block';
  try {
    const response = await fetch(`${SCRIPT_URL}?accion=listar&tipo=videos`);
    const data = await response.json();
    videosData = data.data.map(d => ({ titulo:d[0], url:d[1], autor:d[2], correo:d[3], descripcion:d[4], id:d[5], comentarios:[] })).reverse();
    reconstruirIndiceBusqueda();
    initSwiper(0);
    updateContentOverlay(0);
  } catch(e){ console.error(e); }
  finally{ loader.style.display = 'none'; }
}

// Reconstruir √≠ndice de b√∫squeda
function reconstruirIndiceBusqueda() {
  indiceBusqueda = videosData.map((v,i)=>({i, key: normalizar(v.titulo+" "+v.descripcion), titulo:v.titulo}));
}

// Inicializar swiper
function initSwiper(initialIndex=0){
  if(!swiperInstance){
    swiperInstance = new Swiper('.swiper',{ loop:true, direction:'vertical', slidesPerView:1, spaceBetween:10, zoom:{maxRatio:3} });
    swiperInstance.on('slideChange', ()=>{ updateContentOverlay(swiperInstance.realIndex); });
  }
  const wrapper = document.querySelector('.swiper-wrapper');
  wrapper.innerHTML = '';
  videosData.forEach(video=>{
    const slide = document.createElement('div');
    slide.className='swiper-slide';
    slide.dataset.id = video.id;
    
    const zoomContainer = document.createElement('div');
    zoomContainer.className='swiper-zoom-container';
    
    const videoEl = document.createElement('video');
    videoEl.src = video.url;
    videoEl.controls = true;
    videoEl.autoplay = false;
    videoEl.loop = false;
    videoEl.style.maxWidth = '100%';
    videoEl.style.maxHeight = '100%';
    
    zoomContainer.appendChild(videoEl);
    slide.appendChild(zoomContainer);
    wrapper.appendChild(slide);
});

  swiperInstance.slideToLoop(initialIndex,0,false);
}

// Actualizar overlay y comentarios
function updateContentOverlay(index){
  if(videosData.length<=index) return;
  const video = videosData[index];
  updateInfo(video.titulo, video.descripcion);
  commentsList.innerHTML='';
  cargarComentarios(video.id);
  // Mostrar bot√≥n eliminar
  if(normalizar(video.correo)===normalizar(currentAuthorEmail)){
    deleteAnnouncementBtn.classList.add("visible");
    deleteAnnouncementBtn.onclick = ()=>eliminarVideo(video.id);
  } else { deleteAnnouncementBtn.classList.remove("visible"); }
}

// Cargar comentarios de un video
async function cargarComentarios(videoId){
  try {
    const response = await fetch(`${SCRIPT_URL}?accion=listarComentarios&videoId=${videoId}`);
    const data = await response.json();
    const comentarios = (data.data || []).map(c=>({texto:`${c[2]} (${c[4]}) - ${c[1]}`, textoPuro:c[1], autorCorreo:c[3]}));
    const activeIndex = swiperInstance.realIndex;
    videosData[activeIndex].comentarios = comentarios;
    commentsList.innerHTML='';
    if(comentarios.length>0){
      comentarios.forEach(c=>{
        const li=document.createElement('li');
        const content=document.createElement('div'); content.className='comment-content'; content.textContent=c.texto;
        const delBtnDiv=document.createElement('div'); delBtnDiv.className='delete-btn-container';
        const delBtn=document.createElement('div'); delBtn.className='delete-btn'; delBtn.textContent='Borrar';
        delBtn.onclick=()=>eliminarComentario(videoId, c.textoPuro, c.autorCorreo);
        delBtnDiv.appendChild(delBtn); li.appendChild(delBtnDiv); li.appendChild(content);
        commentsList.appendChild(li);
      });
      commentCountValue.textContent=comentarios.length;
    } else { commentsList.innerHTML='<li>No hay comentarios a√∫n.</li>'; commentCountValue.textContent=0; }
  } catch(e){ console.error(e); }
}

// Eliminar comentario
async function eliminarComentario(videoId, texto, correo){
  loader.style.display='block';
  try {
    const formData = new FormData();
    formData.append('accion','eliminarComentario');
    formData.append('videoId',videoId);
    formData.append('comentario',texto);
    formData.append('correo',correo);
    await fetch(SCRIPT_URL,{method:'POST',body:formData});
    cargarComentarios(videoId);
  } catch(e){ console.error(e); }
  finally{ loader.style.display='none'; }
}

// Eliminar video
async function eliminarVideo(videoId){
  if(!confirm("¬øDeseas eliminar este video?")) return;
  loader.style.display='block';
  try {
    const formData = new FormData();
    formData.append('accion','eliminarAnuncio');
    formData.append('id',videoId);
    formData.append('correo',currentAuthorEmail);
    await fetch(SCRIPT_URL,{method:'POST',body:formData});
    cargarVideos();
  } catch(e){ console.error(e); }
  finally{ loader.style.display='none'; }
}

// Inicializar
document.addEventListener('DOMContentLoaded',()=>{ cargarVideos(); });
</script>
</body>
</html>



