<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Comentarios de Video</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    .swiper { width: 100%; height: 60vh; background:#000; }
    .swiper-slide { display:flex; justify-content:center; align-items:center; }
    .comments-overlay-container { position: absolute; bottom: 70px; width: 100%; max-height: 200px; overflow-y: auto; background: rgba(255,255,255,0.9); }
    .comments-counter { position: absolute; bottom: 10px; right: 10px; cursor: pointer; background: #fff; border-radius: 50%; padding: 5px 10px; display: flex; align-items: center; }
    .comment-input-container { position: absolute; bottom: 0; width: 100%; display: flex; padding: 5px; background: #fff; }
    .send-comment-btn { cursor: pointer; }
    #loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; }
  </style>
</head>
<body>

  <!-- Slider -->
  <div class="swiper">
    <div class="swiper-wrapper"></div>
  </div>

  <!-- Loader -->
  <div id="loader"><span class="spinner">‚è≥</span></div>

  <!-- Overlay de comentarios -->
  <div class="comments-overlay-container" id="commentsOverlay">
    <ul id="commentsList"></ul>
  </div>

  <!-- Contador de comentarios -->
  <div class="comments-counter" id="commentsCounter">
    <span class="icon">üí¨</span>
    <span class="count" id="commentCountValue">0</span>
  </div>

  <!-- Input para comentarios -->
  <div class="comment-input-container">
    <input type="text" id="commentInput" placeholder="Escribe un comentario...">
    <button class="send-comment-btn"><i class="fas fa-paper-plane"></i></button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
  const SCRIPT_URL = "TU_URL_DEL_SCRIPT_AQUI"; // <-- Cambia por tu URL de Google Apps Script

  let swiperInstance = null;
  let videosData = [];
  let currentAuthorName = "An√≥nimo";
  let currentAuthorEmail = "anonimo@correo.com";

  const loader = document.getElementById('loader');
  const commentsList = document.getElementById('commentsList');
  const commentCountValue = document.getElementById('commentCountValue');
  const commentInput = document.getElementById('commentInput');

  // Funci√≥n para mostrar loader
  function showLoader(show){
    loader.style.display = show ? 'block' : 'none';
  }

  // Cargar videos desde Google Sheet
  async function cargarVideos() {
    showLoader(true);
    try {
     const res = await fetch(`${SCRIPT_URL}?accion=listar&tipo=videos`);

      const data = await res.json();
      videosData = data.data || [];
      const wrapper = document.querySelector('.swiper-wrapper');
      wrapper.innerHTML = '';
      videosData.forEach(v=>{
        const slide = document.createElement('div');
        slide.classList.add('swiper-slide');
        slide.dataset.id = v[0]; // ID_Video
        slide.innerHTML = `<iframe width="100%" height="100%" src="${v[3]}" frameborder="0" allowfullscreen></iframe>`;
        wrapper.appendChild(slide);
      });
      initSwiper();
      if(videosData.length>0) listarComentarios(videosData[0][0]);
    } catch(e){ console.error(e); }
    finally { showLoader(false); }
  }

  // Inicializar Swiper
  function initSwiper(){
    swiperInstance = new Swiper('.swiper',{
      slidesPerView:1,
      spaceBetween:10,
      on:{ slideChange: ()=> { const videoId = swiperInstance.slides[swiperInstance.activeIndex].dataset.id; listarComentarios(videoId); }}
    });
  }

  // Listar comentarios de video
  async function listarComentarios(videoId){
    showLoader(true);
    try {
      const res = await fetch(`${SCRIPT_URL}?accion=listarComentarios&videoId=${videoId}`);
      const data = await res.json();
      const comentarios = data.data || [];
      commentsList.innerHTML='';
      if(comentarios.length===0){
        const li = document.createElement('li');
        li.textContent="No hay comentarios a√∫n.";
        commentsList.appendChild(li);
        commentCountValue.textContent='0';
      } else {
        comentarios.forEach(c=>{
          const li = document.createElement('li');
          li.textContent = `${c[2]} (${c[4]}): ${c[1]}`;
          li.dataset.videoId = c[0];
          li.dataset.comentario = c[1];
          li.dataset.correo = c[3];
          commentsList.appendChild(li);
        });
        commentCountValue.textContent=comentarios.length;
      }
    } catch(e){ console.error(e); }
    finally { showLoader(false); }
  }

  // Agregar comentario
  async function agregarComentario(videoId, texto){
    if(!texto) return;
    showLoader(true);
    const formData = new FormData();
    formData.append('accion','agregarComentarioVideo');
    formData.append('videoId', videoId);
    formData.append('comentario', texto);
    formData.append('autor', currentAuthorName);
    formData.append('correo', currentAuthorEmail);
    try{
      const res = await fetch(SCRIPT_URL,{ method:'POST', body: formData });
      const data = await res.json();
      if(data.status==='success'){
        commentInput.value='';
        listarComentarios(videoId);
      } else {
        alert('Error: '+data.message);
      }
    } catch(e){ console.error(e); }
    finally{ showLoader(false); }
  }

  // Eliminar comentario
  async function eliminarComentarioVideo(li){
    const videoId = li.dataset.videoId;
    const comentario = li.dataset.comentario;
    const correo = li.dataset.correo;
    if(!confirm('¬øDeseas eliminar este comentario?')) return;
    showLoader(true);
    const formData = new FormData();
    formData.append('accion','eliminarComentario');
    formData.append('videoId', videoId);
    formData.append('comentario', comentario);
    formData.append('correo', correo);
    try{
      const res = await fetch(SCRIPT_URL,{ method:'POST', body: formData });
      const data = await res.json();
      if(data.status==='success') listarComentarios(videoId);
      else alert('Error: '+data.message);
    } catch(e){ console.error(e); }
    finally{ showLoader(false); }
  }

  // Eventos
  document.querySelector('.send-comment-btn').addEventListener('click', ()=>{
    const activeSlide = swiperInstance.slides[swiperInstance.activeIndex];
    agregarComentario(activeSlide.dataset.id, commentInput.value.trim());
  });

  commentInput.addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const activeSlide = swiperInstance.slides[swiperInstance.activeIndex];
      agregarComentario(activeSlide.dataset.id, commentInput.value.trim());
    }
  });

  commentsList.addEventListener('click', e=>{
    if(e.target.tagName==='LI') eliminarComentarioVideo(e.target);
  });

  document.addEventListener('DOMContentLoaded', cargarVideos);
  </script>
</body>
</html>
