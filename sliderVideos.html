<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Slider de Videos</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
<style>
  body { margin:0; font-family: Arial, sans-serif; }
  .swiper { width: 100%; height: 70vh; background: #000; }
  .swiper-slide { display: flex; justify-content:center; align-items:center; }
  .swiper-slide video { max-width: 100%; max-height: 100%; }
  .content-overlay { padding: 10px; background:#f4f4f4; }
  .comments-overlay-container { max-height: 200px; overflow-y:auto; border-top:1px solid #ccc; }
  .comment-input-container { display:flex; margin-top:5px; }
  .comment-input-container input { flex:1; padding:5px; }
  .comment-input-container button { padding:5px; }
  .delete-announcement-btn { position: fixed; top:10px; right:10px; display:none; background:red; color:#fff; border:none; padding:5px 10px; cursor:pointer; }
  .delete-announcement-btn.visible { display:block; }
  .custom-alert-overlay, #customAlertOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:1000; }
  .custom-alert { background:#fff; padding:20px; border-radius:8px; max-width:90%; max-height:80%; overflow-y:auto; }
  .titles-list { list-style:none; padding:0; margin:0; }
  .titles-list li { padding:5px; cursor:pointer; border-bottom:1px solid #ddd; }
  .hidden-overlay { display:none !important; }
  .highlight { background:yellow; }
</style>
</head>
<body>

<div class="swiper"><div class="swiper-wrapper"></div></div>

<div id="loader"><span class="spinner">‚è≥</span></div>

<div id="lblContador"></div>

<div id="customAlertOverlay" style="display:none">
  <div class="custom-alert">
    <h2 id="alertTitle"></h2>
    <div class="titles-list" id="alertMessage"></div>
  </div>
</div>

<div id="searchOverlay" class="custom-alert-overlay" style="display:none;">
  <div class="custom-alert">
    <h2>Buscar video</h2>
    <input type="text" id="searchInput" placeholder="Escribe para buscar..." style="width:100%; padding:8px; margin:10px 0;">
    <div id="searchResults" class="titles-list"></div>
    <button onclick="cerrarBusqueda()">Cerrar</button>
  </div>
</div>

<div class="content-overlay" id="contentOverlay">
  <h3 id="currentTitle"></h3>
  <p id="currentDescription"></p>
</div>

<div class="comments-overlay-container" id="commentsOverlay">
  <ul id="commentsList"></ul>
</div>

<div class="comments-counter" id="commentsCounter">
  <span class="icon">üí¨</span>
  <span class="count" id="commentCountValue">0</span>
</div>

<div class="comment-input-container">
  <input type="text" id="commentInput" placeholder="Escribe un comentario...">
  <button class="send-comment-btn">Enviar</button>
</div>

<button id="deleteAnnouncementBtn" class="delete-announcement-btn">
  Eliminar video
</button>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
const SCRIPT_URL = "TU_URL_DE_APPS_SCRIPT_AQUI"; // Reemplaza con tu URL de Apps Script

let videosData = [];
let swiperInstance = null;
let comentariosPorVideo = {};
let currentAuthorEmail = "deimer.herrera91@gmail.com";
let currentAuthorName = "An√≥nimoDH";

const loader = document.getElementById('loader');
const lblContador = document.getElementById("lblContador");
const contentOverlay = document.getElementById('contentOverlay');
const commentsOverlay = document.getElementById('commentsOverlay');
const commentsCounter = document.getElementById('commentsCounter');
const commentCountValue = document.getElementById('commentCountValue');
const commentsList = document.getElementById('commentsList');
const currentTitle = document.getElementById('currentTitle');
const currentDescription = document.getElementById('currentDescription');
const commentInputContainer = document.querySelector('.comment-input-container');
const commentInput = document.getElementById('commentInput');
const sendCommentBtn = document.querySelector('.send-comment-btn');
const deleteAnnouncementBtn = document.getElementById('deleteAnnouncementBtn');

// Funci√≥n para normalizar texto
function normalizar(txt) {
  return (txt||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
}

// Cargar videos desde hoja
async function cargarVideos() {
  loader.style.display='block';
  try {
    const res = await fetch(`${SCRIPT_URL}?accion=listar&tipo=videos`);
    const data = await res.json();
    if(data.status==="success") {
      videosData = data.data.map(v => ({
        titulo: v[0]||"",
        url: v[1]||"",
        autor: v[2]||"",
        correo: v[3]||"",
        descripcion: v[4]||"",
        id: v[5]||""
      }));
      initSwiper();
    }
  } catch(e){ console.error(e); }
  finally{ loader.style.display='none'; }
}

// Cargar comentarios de un video
async function cargarComentarios(videoId){
  try {
    const res = await fetch(`${SCRIPT_URL}?accion=listarComentarios&videoId=${videoId}`);
    const data = await res.json();
    comentariosPorVideo[videoId] = data.data.map(c=>({
      texto: `${c[2]} (${c[4]}) - ${c[1]}`,
      autorCorreo: c[3],
      textoPuro: c[1]
    }));
  } catch(e){ console.error(e); }
}

// Actualizar overlay de contenido y comentarios
function updateContentOverlay(index){
  if(videosData.length<=index) return;
  const video = videosData[index];
  currentTitle.textContent = video.titulo;
  currentDescription.textContent = video.descripcion;

  commentsList.innerHTML='';
  const comentarios = comentariosPorVideo[video.id]||[];
  if(comentarios.length>0){
    comentarios.forEach(c=>{
      const li = document.createElement('li');
      li.textContent = c.texto;
      li.dataset.correo=c.autorCorreo;
      li.dataset.texto=c.textoPuro;
      commentsList.appendChild(li);
    });
    commentCountValue.textContent = comentarios.length;
  } else {
    const li = document.createElement('li'); li.textContent="No hay comentarios a√∫n.";
    commentsList.appendChild(li);
    commentCountValue.textContent = 0;
  }

  if(normalizar(video.correo)===normalizar(currentAuthorEmail)){
    deleteAnnouncementBtn.classList.add("visible");
    deleteAnnouncementBtn.onclick = ()=>eliminarVideo(video.id);
  } else {
    deleteAnnouncementBtn.classList.remove("visible");
  }
}

// Inicializar Swiper
function initSwiper(){
  const swiperWrapper = document.querySelector('.swiper-wrapper');
  swiperWrapper.innerHTML='';
  videosData.forEach(v=>{
    const slide=document.createElement('div');
    slide.classList.add('swiper-slide');
    const videoEl = document.createElement('video');
    videoEl.src=v.url;
    videoEl.controls=true;
    slide.appendChild(videoEl);
    swiperWrapper.appendChild(slide);
  });

  swiperInstance = new Swiper('.swiper',{
    loop:true,
    direction:'vertical',
    slidesPerView:1,
    spaceBetween:10
  });

  swiperInstance.on('slideChange', async ()=>{
    const idx = swiperInstance.realIndex;
    await cargarComentarios(videosData[idx].id);
    updateContentOverlay(idx);
  });

  // Cargar comentarios del primer video
  if(videosData.length>0){
    cargarComentarios(videosData[0].id).then(()=>updateContentOverlay(0));
  }
}

// Enviar comentario
async function enviarComentario(){
  const texto = commentInput.value.trim();
  if(!texto || !swiperInstance) return;
  const idx = swiperInstance.realIndex;
  const video = videosData[idx];
  loader.style.display='block';
  try {
    const formData = new FormData();
    formData.append('accion','agregarComentarioVideo');
    formData.append('videoId',video.id);
    formData.append('comentario',texto);
    formData.append('autor',currentAuthorName);
    formData.append('correo',currentAuthorEmail);
    const res = await fetch(SCRIPT_URL,{method:'POST',body:formData});
    const data = await res.json();
    if(data.status==="success"){
      commentInput.value='';
      await cargarComentarios(video.id);
      updateContentOverlay(idx);
    }
  } catch(e){ console.error(e); }
  finally{ loader.style.display='none'; }
}

sendCommentBtn.addEventListener('click', enviarComentario);
commentInput.addEventListener('keydown', e=>{ if(e.key==='Enter') enviarComentario(); });

// Eliminar comentario
async function eliminarComentario(videoId,texto,correo){
  loader.style.display='block';
  try {
    const formData = new FormData();
    formData.append('accion','eliminarComentario');
    formData.append('videoId',videoId);
    formData.append('comentario',texto);
    formData.append('correo',correo);
    const res = await fetch(SCRIPT_URL,{method:'POST',body:formData});
    const data = await res.json();
    if(data.status==="success"){
      const idx = swiperInstance.realIndex;
      await cargarComentarios(videoId);
      updateContentOverlay(idx);
    }
  } catch(e){ console.error(e); }
  finally{ loader.style.display='none'; }
}

// Eliminar video
async function eliminarVideo(videoId){
  alert("Implementa tu funci√≥n de eliminar video seg√∫n tu Apps Script si es necesario");
}

// Inicializar
document.addEventListener('DOMContentLoaded', cargarVideos);
</script>
</body>
</html>
