<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Galería de Videos</title>
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg1: #000;
            --bg2: #000;
            --text: #fff;
            --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--bg1), var(--bg2));
            font-family: "Segoe UI", Arial, sans-serif;
            color: var(--text);
            overflow: hidden;
        }

    /* Botones flotantes */
    .floating-buttons {
        position: fixed;
        bottom: 90px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        z-index: 2000;
    }
    .fab {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: transparent;
        color: white;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .fab.danger {}
.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
}
.modal-actions button {
    flex: 1;
}

        

    /* Modal */
    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
    }
    .modal.hidden { display: none; }
    .modal-content {
        background: #111;
        padding: 20px;
        border-radius: 10px;
        width: 300px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        color: #fff;
    }
    .modal-content input { padding: 6px; }

    /* Progreso flotante */
    .progress-toast {
        position: fixed;
        top: 15px;
        right: 15px;
        background: rgba(0,0,0,0.8);
        color: #fff;
        padding: 10px 14px;
        border-radius: 6px;
        z-index: 4000;
        width: 200px;
    }
    .progress-toast.hidden { display: none; }
    .progress-toast .bar {
        height: 4px;
        background: #28a745;
        width: 0%;
        margin-bottom: 6px;
        transition: width 0.3s ease;
    }


        
        .swiper {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .swiper-slide {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: stretch;
            position: relative;
            background: #000;
        }

        .player-card {
            position: relative;
            width: 100%;
            height: calc(100vh - 120px);
            background: #000;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            border-radius: 10px;
        }

        .poster {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #111;
            background-size: cover;
            background-position: center center;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        .play-btn {
            display: grid;
            place-items: center;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(2px);
            font-size: 28px;
            line-height: 1;
            border: 2px solid #fff;
        }

        .player-iframe {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            border: 0;
            background: #000;
        }

/* Truncamiento para el contenedor del título y la descripción */
#video-title-fixed .text-container {
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2; /* Truncar a 2 líneas por defecto */
    transition: -webkit-line-clamp 0.3s ease;
    cursor: pointer; /* Cursor de puntero para indicar que es clicable */
    position: relative;
    max-height: 4em; /* Altura máxima cuando está truncado */
    line-height: 1.2;
}

#video-title-fixed .text-container.expanded {
    -webkit-line-clamp: unset;
    cursor: pointer;
    overflow-y: auto; /* Hacer que el contenedor sea scrollable si el contenido es muy largo */
    max-height: 60vh; /* <<-- Ajuste: Altura máxima al expandir (50% de la altura de la ventana) */
    padding-right: 15px; /* Espacio para la barra de desplazamiento */
}

/* Estilo para el botón de 'más' o 'menos' */
#video-title-fixed .toggle-text {
    color: #ccc;
    font-size: 12px;
    font-weight: bold;
    user-select: none;
    display: inline-block;
    position: absolute; /* Colocar en la esquina para que siempre esté visible */
    bottom: 0;
    right: 20px; /* <<-- Ajuste: Separación del borde derecho */
    background: rgba(0, 0, 0, 0.5); /* Fondo semitransparente para que sea legible */
    padding: 2px 5px;
    border-radius: 3px;
    backdrop-filter: blur(2px);
}

#video-title-fixed {
    position: absolute;
    top: 0;
    left: 10px; /* Ajuste: Desplaza el contenedor 10px desde el borde izquierdo */
    width: auto; /* Ajuste: El ancho se ajustará al contenido + márgenes */
    max-width: 80%; /* Mantienes este ajuste para el ancho máximo */
    z-index: 1000;
    background: rgba(0,0,0,0.3);
    transition: opacity 0.18s ease;
    opacity: 1;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 6px 10px;
    margin: 0; /* Ajuste: Elimina el centrado para que 'left' funcione */
    right: auto; /* Ajuste: Desactiva el valor de la derecha */
}

#video-title-fixed .video-title {
    font-size: 18px;
    font-weight: 600;
    text-align: left;
    color: #f1f1f1;
}

#video-title-fixed .video-desc {
    font-size: 14px;
    opacity: 0.85;
    text-align: left;
    color: #ddd;
}
/* 🔔 Notificaciones */
#notification-wrapper {
  position: fixed;
  right: 20px;
  bottom: 140px; /* la subimos para que quede arriba del bote */
  z-index: 5000;
}

#notification-btn {
  position: relative;
  background: transparent;   /* 👈 Igual que el bote */
  border: none;
  border-radius: 50%;
  width: 40px;              /* 👈 mismo tamaño que el fab */
  height: 40px;
  color: white;
  font-size: 24px;
  cursor: pointer;
  display: flex;            /* 👈 centra el icono */
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.4); /* 👈 igual que el bote */
}


#notification-count {
  display: none; /* 👈 arranca escondido */
  position: absolute;
  top: -5px;
  right: -5px;
  background: red;
  color: white;
  font-size: 12px;
  font-weight: bold;
  padding: 2px 6px;
  border-radius: 50%;
}




#notification-list {
  position: absolute;
  top: 55px;
  right: 0;
  background: #222;
  border: 1px solid #444;
  border-radius: 10px;
  width: 260px;
  max-height: 320px;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0,0,0,0.6);
}
#notification-list.hidden { display: none; }
#notification-list div {
  padding: 10px;
  border-bottom: 1px solid #333;
  cursor: pointer;
  color: #ddd;
}
#notification-list div:hover {
  background: #333;
}


        

        #loader {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            z-index: 10;
            color: #fff;
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.7);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #loader .spinner {
            display: inline-block;
            animation: spin 1.1s linear infinite;
        }

        .touch-blocker {
            position: absolute;
            inset: 0;
            z-index: 1;
            display: none;
        }

        .controls-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 5;
            transition: opacity 0.3s ease;
            opacity: 0;
        }

        .player-card:hover .controls-bar {
            opacity: 1;
        }
        
        .center-play-pause-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: grid;
            place-items: center;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.55);
            border: 2px solid #fff;
            color: #fff;
            font-size: 28px;
            cursor: pointer;
            z-index: 6;
            transition: opacity 0.3s ease;
            opacity: 0;
        }

        .player-card:hover .center-play-pause-btn {
            opacity: 1;
        }

        .play-pause-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }

        .progress-bar {
            flex-grow: 1;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
        }
        .progress {
            height: 100%;
            width: 0%;
            background: #ff0000;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .volume-control input[type="range"] {
            width: 60px;
            -webkit-appearance: none;
            background: transparent;
        }
        .volume-control input[type="range"]::-webkit-slider-runnable-track {
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 1.5px;
        }
        .volume-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #fff;
            margin-top: -4.5px;
        }
        .volume-icon {
            font-size: 20px;
        }

        .time {
            font-size: 12px;
            color: #fff;
        }
.comments-overlay-container {
  position: fixed;
  bottom: 90px;
  left: 0; right: 0;
  max-height: 40vh;
  background: rgba(32, 32, 32, 0.90); /* Fondo oscuro y semi-transparente */
  color: #fff;                        /* Letras blancas */
  box-shadow: 0 -2px 12px #0005;      /* Sombra más marcada */
  overflow-y: auto;
  z-index: 20;
  border-radius: 14px 14px 0 0;
  transition: max-height 0.25s;
}
.comments-overlay-container.expanded {
  max-height: 80vh;
}
.comments-overlay-container.hidden-overlay {
  display: none;
}

.comments-counter {
  position: fixed;
  bottom: 70px;
  right: 16px;
  background: #fff;
  border-radius: 24px;
  box-shadow: 0 2px 8px #0002;
  padding: 8px 14px;
  font-size: 17px;
  z-index: 21;
  display: flex;
  align-items: center;
}
.comments-counter .icon {
  margin-right: 7px;
}

.comment-input-container {
  position: fixed;
  bottom: 20px;
  left: 0; right: 0;
  z-index: 22;
  display: flex;
  justify-content: center;
  align-items: center;
}
.comment-input-container input {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 16px;
  margin-right: 8px;
}
.comment-input-container button {
  background: #007bff;
  color: #fff;
  border: none;
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 18px;
  cursor: pointer;
}

#commentsList {
  list-style: none;
  padding: 0;
  margin: 0;
}
#commentsList li {
  margin: 0;
  padding: 10px 15px;
  border-bottom: 1px solid #444;       /* Más oscuro */
  display: flex;
  align-items: center;
  background: transparent;              /* Fondo transparente */
  position: relative;
  overflow-x: hidden;
  color: #fff;                         /* Letras blancas */
}
.comment-content {
  flex: 1;
  transition: transform 0.3s;
  color: #fff;                         /* Letras blancas */
}
.delete-btn-container {
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #e74c3c;
  color: #fff;
  font-weight: bold;
  border-radius: 0 12px 12px 0;
  transition: transform 0.3s;
  z-index: 1;
}
.delete-btn {
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 10px;
  background: #c0392b;
  color: #fff;
  margin-left: 8px;
}

        
    </style>
</head>
<body>

<!-- Overlay flotante para comentarios -->
<div class="comments-overlay-container" id="commentsOverlay">
  <ul id="commentsList"></ul>
</div>
<div class="comments-counter" id="commentsCounter">
  <span class="icon">💬</span>
  <span class="count" id="commentCountValue">0</span>
</div>
<div class="comment-input-container">
  <input type="text" id="commentInput" placeholder="Escribe un comentario...">
  <button class="send-comment-btn"><i class="fas fa-paper-plane"></i></button>
</div>

    
<!-- Notificaciones -->
<div id="notification-wrapper">
  <button id="notification-btn">
    <i class="fas fa-bell"></i>
    <span id="notification-count"></span>
  </button>
  <div id="notification-list" class="hidden"></div>
</div>

    
<div id="custom-alert-modal" class="modal hidden">
  <div class="modal-content">
    <h3>¡Atención!</h3>
    <p id="custom-alert-message"></p>
    <div class="modal-actions">
      <button id="custom-alert-ok" style="background:#007bff; color:white; padding:8px; border:none; border-radius:6px; cursor:pointer;">Aceptar</button>
    </div>
  </div>
</div>
<!-- Modal de eliminación -->
<div id="delete-modal" class="modal hidden">
  <div class="modal-content">
    <h3>¿Eliminar Video?</h3>
    <p id="delete-video-title">¿Seguro que deseas eliminar este video?</p>
    <div class="modal-actions">
      <button id="delete-confirm" style="background:#dc3545; color:white; padding:8px; border:none; border-radius:6px; cursor:pointer;">Eliminar</button>
      <button id="delete-cancel" style="background:#444; color:white; padding:8px; border:none; border-radius:6px; cursor:pointer;">Cancelar</button>
    </div>
  </div>
</div>

    
        <!-- BOTONES flotantes -->
   <div class="floating-buttons">
  <button id="btn-delete" class="fab danger"><i class="fas fa-trash"></i></button>
</div>

  

  <div class="swiper">
  <div id="video-title-fixed">
    <div class="video-title"></div>
    <div class="video-desc"></div>
  </div>
  <div class="swiper-wrapper" id="slides"></div>
</div>


  <div id="loader"><span class="spinner">⏳</span></div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec";

// === Variables globales ===
const commentsOverlay = document.getElementById('commentsOverlay');
const commentsCounter = document.getElementById('commentsCounter');
const commentCountValue = document.getElementById('commentCountValue');
const commentsList = document.getElementById('commentsList');
const commentInputContainer = document.querySelector('.comment-input-container');
const commentInput = document.getElementById('commentInput');
const sendCommentBtn = document.querySelector('.send-comment-btn');
let videosData = []; // [{ id, titulo, link, descripcion, comentarios: [...] }]
let lastVideos = [];
let notifications = [];
let swiper = null;
let usuarioCorreo = "deimer.herrera91@gmail.com"; // Ajusta
let usuarioAutor = "AnónimoDH"; // Ajusta
let contadorComentariosAnterior = -1;
let lastTapTime = 0;
let activeComment = null;
let startX = 0;
let isSwiping = false;

// Función para timeout en fetch (para evitar esperas infinitas)
function fetchWithTimeout(url, options = {}, timeout = 5000) {
  return Promise.race([
    fetch(url, options),
    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), timeout))
  ]);
}

// === Eventos de UI ===
document.querySelector('.swiper').addEventListener('click', () => {
  const currentTime = new Date().getTime();
  if (currentTime - lastTapTime > 300) {
    commentsOverlay.classList.toggle('hidden-overlay');
    commentsCounter.classList.toggle('hidden-overlay');
    commentInputContainer.classList.toggle('hidden-overlay');
  }
  lastTapTime = currentTime;
});

commentsOverlay.addEventListener('click', (e) => {
  if (!isSwiping) commentsOverlay.classList.toggle('expanded');
  isSwiping = false;
});

// Swipe-to-delete (sin cambios)
commentsList.addEventListener('touchstart', (e) => {
  const commentElement = e.target.closest('li');
  if (!commentElement) return;
  const commentData = commentElement.dataset;
  if (normalizeText(commentData.correo) === normalizeText(usuarioCorreo)) {
    startX = e.touches[0].clientX;
    activeComment = commentElement;
    activeComment.querySelector('.comment-content').style.transition = 'none';
    isSwiping = false;
  }
});

commentsList.addEventListener('touchmove', (e) => {
  if (!activeComment) return;
  const currentX = e.touches[0].clientX;
  const diffX = currentX - startX;
  if (Math.abs(diffX) > 10) isSwiping = true;
  const commentContent = activeComment.querySelector('.comment-content');
  let deleteBtnContainer = activeComment.querySelector('.delete-btn-container');
  if (diffX > 0) {
    commentContent.style.transform = `translateX(${diffX}px)`;
    if (deleteBtnContainer) deleteBtnContainer.style.transform = `translateX(0)`;
  } else {
    commentContent.style.transform = `translateX(0)`;
    if (deleteBtnContainer) deleteBtnContainer.style.transform = `translateX(-100%)`;
  }
});

commentsList.addEventListener('touchend', (e) => {
  if (!activeComment) return;
  const swipeThreshold = 50;
  const diffX = e.changedTouches[0].clientX - startX;
  const commentContent = activeComment.querySelector('.comment-content');
  let deleteBtnContainer = activeComment.querySelector('.delete-btn-container');
  commentContent.style.transition = 'transform 0.3s ease';
  if (diffX > swipeThreshold) {
    commentContent.style.transform = `translateX(100px)`;
    if (!deleteBtnContainer) {
      deleteBtnContainer = document.createElement('div');
      deleteBtnContainer.className = 'delete-btn-container';
      let deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-btn';
      deleteBtn.textContent = 'Borrar';
      deleteBtnContainer.appendChild(deleteBtn);
      activeComment.insertBefore(deleteBtnContainer, commentContent);
      deleteBtnContainer.style.transform = `translateX(0)`;
      deleteBtn.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const commentData = activeComment.dataset;
        eliminarComentario(getActiveVideoId(), commentData.texto, commentData.correo);
      });
    } else {
      deleteBtnContainer.style.transform = `translateX(0)`;
    }
  } else {
    commentContent.style.transform = `translateX(0)`;
    if (deleteBtnContainer) deleteBtnContainer.style.transform = `translateX(-100%)`;
  }
  activeComment = null;
  startX = 0;
});

// === Funciones de lógica ===
function getActiveVideoId() {
  if (!swiper) return null;
  const activeSlide = swiper.slides[swiper.activeIndex];
  if (!activeSlide) return null;
  return activeSlide.dataset.videoid || null;
}

function normalizeText(text) {
  return (text || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toLowerCase();
}

function normalizarComentarios(data) {
  if (!Array.isArray(data.data)) return [];
  return data.data.reverse().map(c => ({
    autor: c[2] || "Anónimo",
    comentario: c[1] || "",
    fecha: c[4] || "",
    correo: c[3] || ""
  })).filter(c => c.autor || c.comentario || c.fecha);
}

async function cargarComentarios(videoId, silent = false) {
  const video = videosData.find(v => v.id === videoId);
  if (video && video.comentarios && !silent) {
    updateCommentsOverlay(swiper?.realIndex || 0);
    return video.comentarios;
  }

  try {
    const res = await fetchWithTimeout(`${SCRIPT_URL}?accion=listarComentarios&videoId=${encodeURIComponent(videoId)}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const comentarios = normalizarComentarios(data);

    const video = videosData.find(v => v.id === videoId);
    if (video) video.comentarios = comentarios;

    if (!silent) updateCommentsOverlay(swiper?.realIndex || 0);
    return comentarios;
  } catch (e) {
    console.error('Error cargando comentarios para', videoId, ':', e);
    if (!silent) {
      commentsList.innerHTML = '<li>Error al cargar comentarios (timeout o quota). Intenta deslizar de nuevo.</li>';
      commentCountValue.textContent = '0';
    }
    return [];
  }
}

function updateCommentsOverlay(index) {
  if (videosData.length <= index || !videosData[index]) {
    commentsList.innerHTML = '<li>No hay datos disponibles.</li>';
    commentCountValue.textContent = '0';
    return;
  }

  const video = videosData[index];
  commentsList.innerHTML = '';
  commentsOverlay.classList.remove('expanded');

  const lista = video.comentarios || [];
  if (lista.length === 0) {
    const li = document.createElement('li');
    li.textContent = "Sé el primero en comentar...";
    commentsList.appendChild(li);
    commentCountValue.textContent = "0";
    return;
  }

  lista.forEach(c => {
    const li = document.createElement('li');
    li.classList.add('deletable');
    const commentContent = document.createElement('div');
    commentContent.className = 'comment-content';
    commentContent.textContent = `${c.autor} (${c.fecha}) - ${c.comentario}`;
    li.appendChild(commentContent);
    li.dataset.correo = c.correo;
    li.dataset.texto = c.comentario;

    if (normalizeText(c.correo) === normalizeText(usuarioCorreo)) {
      const deleteBtnContainer = document.createElement('div');
      deleteBtnContainer.className = 'delete-btn-container';
      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-btn';
      deleteBtn.textContent = 'Borrar';
      deleteBtnContainer.appendChild(deleteBtn);
      li.appendChild(deleteBtnContainer);
      deleteBtn.addEventListener('click', (ev) => {
        ev.stopPropagation();
        eliminarComentario(video.id, c.comentario, c.correo);
      });
    }
    commentsList.appendChild(li);
  });
  commentCountValue.textContent = lista.length;
}

async function enviarComentario() {
  const texto = commentInput.value.trim();
  const videoId = getActiveVideoId();
  if (!texto || !videoId) return;
  sendCommentBtn.disabled = true;
  const loader = document.getElementById("loader");
  loader.style.display = "flex";
  try {
    await fetchWithTimeout(SCRIPT_URL, {
      method: "POST",
      body: new URLSearchParams({
        accion: "agregarComentarioVideo",
        videoId,
        comentario: texto,
        autor: usuarioAutor,
        correo: usuarioCorreo,
      })
    });
    commentInput.value = "";
    await cargarComentarios(videoId, true); // Actualiza caché
    updateCommentsOverlay(swiper?.realIndex || 0);
  } catch (e) {
    console.error("Error al enviar comentario:", e);
    commentsList.innerHTML = '<li>Error al enviar comentario.</li>';
  } finally {
    sendCommentBtn.disabled = false;
    loader.style.display = "none";
  }
}

async function eliminarComentario(videoId, comentario, correo) {
  if (!videoId || !comentario || !correo) return;
  const loader = document.getElementById("loader");
  loader.style.display = "flex";
  try {
    await fetchWithTimeout(SCRIPT_URL, {
      method: "POST",
      body: new URLSearchParams({
        accion: "eliminarComentario",
        videoId,
        comentario,
        correo
      })
    });
    await cargarComentarios(videoId, true); // Actualiza caché
    updateCommentsOverlay(swiper?.realIndex || 0);
  } catch (e) {
    console.error("Error al eliminar comentario:", e);
    commentsList.innerHTML = '<li>Error al eliminar comentario.</li>';
  } finally {
    loader.style.display = "none";
  }
}

async function verificarComentariosVideos() {
  try {
    const res = await fetchWithTimeout(`${SCRIPT_URL}?accion=obtenerContadorComentarios`);
    const data = await res.json();
    const totalComentariosActual = data.contadorComentarios || 0;

    if (data.comentarios && swiper) {
      Object.keys(data.comentarios).forEach(videoId => {
        const video = videosData.find(v => v.id === videoId);
        if (video) video.comentarios = normalizarComentarios(data);
      });
      updateCommentsOverlay(swiper.realIndex); // Actualiza actual si cambió
    }

    if (contadorComentariosAnterior !== -1 && totalComentariosActual !== contadorComentariosAnterior) {
      console.log("💬 Cambio detectado, actualizando...");
    }
    contadorComentariosAnterior = totalComentariosActual;
  } catch (e) {
    console.error("Error verificando comentarios:", e);
  }
}

setInterval(verificarComentariosVideos, 5000);

// Función createSlide (sin cambios, asumiendo getEmbedInfo existe)
function createSlide(titulo, link, descripcion, id) {
  const { embedSrc, poster } = getEmbedInfo(link); // Asume esta función existe
  const slide = document.createElement("div");
  slide.className = "swiper-slide";
  slide.dataset.title = titulo || "Video";
  slide.dataset.descripcion = descripcion || "";
  slide.dataset.videoid = id || "";

  const card = document.createElement("div");
  card.className = "player-card";
  card.dataset.embed = embedSrc;

  const posterEl = document.createElement("div");
  posterEl.className = "poster";
  if (poster) posterEl.style.backgroundImage = `url("${poster}")`;

  const playBtn = document.createElement("div");
  playBtn.className = "play-btn";
  playBtn.innerHTML = '<i class="fas fa-play"></i>';
  posterEl.appendChild(playBtn);

  posterEl.addEventListener("click", () => {
    mountIframe(card); // Asume esta función existe
  });

  card.appendChild(posterEl);
  slide.appendChild(card);
  return slide;
}

// updateFixedTitle (sin cambios)
function updateFixedTitle(swiperInstance) {
  const fixedBox = document.getElementById("video-title-fixed");
  if (!fixedBox || !swiperInstance) return;

  const activeSlide = swiperInstance.slides[swiperInstance.activeIndex] || document.querySelector('.swiper-slide-active');
  if (!activeSlide) return;

  const newTitle = activeSlide.dataset.title || "Video";
  const newDesc = activeSlide.dataset.descripcion || "";

  const titleEl = fixedBox.querySelector(".video-title");
  const descEl = fixedBox.querySelector(".video-desc");

  const currentTitle = titleEl.querySelector('.text-container')?.textContent;
  const currentDesc = descEl.querySelector('.text-container')?.textContent;
  
  if (currentTitle === newTitle && currentDesc === newDesc) return;

  fixedBox.style.opacity = 0;

  setTimeout(() => {
    const setupExpandableText = (element, text) => {
      element.innerHTML = `<span class="text-container">${text}</span>`;
      const container = element.querySelector('.text-container');
      setTimeout(() => {
        if (container.scrollHeight > container.clientHeight) {
          const toggleButton = document.createElement('span');
          toggleButton.className = 'toggle-text';
          toggleButton.textContent = '...más';
          element.appendChild(toggleButton);
          element.addEventListener('click', () => {
            const isExpanded = container.classList.contains('expanded');
            if (isExpanded) {
              container.classList.remove('expanded');
              toggleButton.textContent = '...más';
            } else {
              container.classList.add('expanded');
              toggleButton.textContent = 'mostrar menos';
            }
          });
        } else {
          const existingButton = element.querySelector('.toggle-text');
          if (existingButton) existingButton.remove();
          const clonedElement = element.cloneNode(true);
          element.parentNode.replaceChild(clonedElement, element);
        }
      }, 50);
    };

    setupExpandableText(titleEl, newTitle);
    setupExpandableText(descEl, newDesc);
    fixedBox.style.opacity = 1;
  }, 120);
}

// Otras funciones asumidas (implementa si no existen)
function getEmbedInfo(link) {
  // Lógica para extraer embedSrc y poster de link (ej. YouTube)
  return { embedSrc: link, poster: '' }; // Placeholder
}

function mountIframe(card) {
  // Lógica para montar iframe en card
  console.log('Mounting iframe');
}

function cleanupIframesExceptActive() {
  // Lógica para limpiar iframes
  console.log('Cleaning iframes');
}

function renderNotifications() {
  // Lógica para render notificaciones
  console.log('Rendering notifications');
}

// === Carga principal (optimizada) ===
async function cargarVideos(checkNew = false) {
  const loader = document.getElementById("loader");
  if (!checkNew) loader.style.display = "flex";
  try {
    console.log('Cargando videos...');
    const res = await fetchWithTimeout(`${SCRIPT_URL}?accion=listar&tipo=videos`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const wrapper = document.getElementById("slides");
    if (!checkNew) wrapper.innerHTML = "";

    let newVideos = [];
    if (Array.isArray(data.data)) {
      data.data.forEach((row) => {
        const titulo = row[0];
        const link = row[1];
        const descripcion = row[4] || "";
        const id = row[5];
        newVideos.push({ id, titulo, link, descripcion, comentarios: [] }); // Inicial sin comentarios

        if (!checkNew) {
          wrapper.appendChild(createSlide(titulo, link, descripcion, id));
        }
      });
    }

    videosData = newVideos;

    // Lógica checkNew (sin cambios)
    if (checkNew) {
      const linksActivos = newVideos.map(v => v.link);
      Array.from(wrapper.children).forEach(slide => {
        const card = slide.querySelector(".player-card");
        if (card && !linksActivos.includes(card.dataset.embed)) {
          wrapper.removeChild(slide);
          if (swiper) swiper.update();
        }
      });

      newVideos.forEach(v => {
        if (!lastVideos.find(old => old.link === v.link)) {
          notifications.unshift(v);
        }
      });
      if (notifications.length > 0) renderNotifications();
    }

    lastVideos = newVideos;

    if (!checkNew) {
      if (swiper) swiper.destroy(true, true);
      swiper = new Swiper(".swiper", {
        loop: true,
        direction: "horizontal",
        slidesPerView: 1,
        spaceBetween: 10,
        pagination: false,
        on: {
          init() {
            updateFixedTitle(this);
            const initialIndex = this.realIndex;
            // Precarga solo inicial
            if (videosData[initialIndex]) {
              cargarComentarios(videosData[initialIndex].id, true).then(() => {
                updateCommentsOverlay(initialIndex);
              });
            }
          },
          slideChange() {
            cleanupIframesExceptActive();
            updateFixedTitle(this);
            const index = this.realIndex;
            const videoId = getActiveVideoId();
            if (videosData[index] && !videosData[index].comentarios.length) {
              // Carga en background si no cached
              cargarComentarios(videoId, true).then(() => {
                updateCommentsOverlay(index); // Render instantáneo una vez listo
              });
            } else {
              updateCommentsOverlay(index); // Instantáneo si cached
            }
          },
          slideChangeTransitionEnd() {
            updateFixedTitle(this);
          }
        },
      });

      cleanupIframesExceptActive();
      updateFixedTitle(swiper);
    }
    console.log('Videos cargados exitosamente');
  } catch (e) {
    console.error("Error cargando videos:", e);
    commentsList.innerHTML = '<li>Error al cargar videos. Verifica conexión o quotas en GAS.</li>';
  } finally {
    loader.style.display = "none"; // Siempre oculta loader
  }
}

// Input UX (sin cambios)
sendCommentBtn.addEventListener('click', enviarComentario);
commentInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') enviarComentario();
});
commentInput.addEventListener('focus', () => {
  document.body.style.transform = `translateY(-40%)`;
});
commentInput.addEventListener('blur', () => {
  document.body.style.transform = `translateY(0)`;
});

// Inicialización
document.addEventListener('DOMContentLoaded', () => {
  cargarVideos(); // Carga inicial sin checkNew
});
</script>
</body>
</html>





